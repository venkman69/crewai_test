#!/bin/bash
# add path to uv
export PATH=$PATH:~/.local/bin
install_uv () {
    if ! command -v uv &> /dev/null
    then
        >&2 echo "Installing uv.."
        curl -LsSf https://astral.sh/uv/install.sh | sh
    else
        >&2 echo "uv is available $(command -v uv)"
    fi
}


stop () {
    if [ -f $pidfile ]
    then
        psid=`cat $pidfile`
        kill  $psid
        if [ $? -eq 0 ]
        then
            >&2 echo "Process killed"
            rm $pidfile
        else
            >&2 echo "Process did not die"
            exit 1
        fi
    fi
}
kill_all() {
    for pid_file in $SCRIPTDIR/../work/.*.pid
    do
        pid=$(cat $pid_file)
        if [ -n "$pid" ] && ps -p $pid > /dev/null; then
            >&2 echo "Killing process $pid"
            kill $pid
        fi
    done
}
status() {
    if [ -f $pidfile ]
    then
        psid=`cat $pidfile`
        ps -p $psid >/dev/null
        if [ $? -eq 0 ]
        then
            >&2 echo "Process is still running [$psid]"
            return 0
        else
            >&2 echo "Process is not running"
            return 1
        fi
    else
        >&2 echo "Process is not running"
        return 1
    fi
}
install_python() {
    install_uv
    uv python find "${PYTHON_VERSION}" >/dev/null
    if [ $? -ne 0 ]
    then
        >&2 echo "Installing Python $PYTHON_VERSION"
        uv python install $PYTHON_VERSION
    else
        >&2 echo "Python $PYTHON_VERSION is already installed"
    fi
}
makevenv() {
    if [ ! -d venv ]
    then
        install_uv
        >&2 echo "Creating virtual environment"
        uv venv venv --python $PYTHON_VERSION
    fi
    . ./venv/bin/activate
    >&2 echo "Installing dependencies"
    if [ -f pyproject.toml ]; then
        >&2 echo "Running uv sync on pyproject.toml"
        export UV_PROJECT_ENVIRONMENT=venv
        uv sync
    else
        uv pip install setuptools
        uv pip install -r requirements.txt
    fi
}
rebuild() {
    #set a lock file to prevent multiple rebuilds
    lockfile="./work/.rebuild.lock"
    if [ -f $lockfile ]; then
        >&2 echo "Rebuild already in progress, waiting for it to finish"
        while [ -f $lockfile ]; do
            sleep 10
        done
        >&2 echo "Rebuild finished"
        return
    fi
    >&2 echo "Rebuilding application"
    touch $lockfile
    kill_all
    git pull
    rm -rf venv
    makevenv
    rm $lockfile
    >&2 echo "Rebuild complete"
}
git_check() {
    git fetch
    is_behind=$(git status -uno | grep behind)
    if [ "$is_behind" = "" ];then
        >&2 echo "git is up to date"
        return 0
    else
        >&2 echo "Change detected, rebuilding"
        return 1
    fi
}

start() {
    date
    git_check
    if [ $? -eq 1 ]; then
        >&2 echo "Git was modified, rebuilding"
        rebuild
    else
        makevenv
    fi
    status
    if [ $? -eq 1 ]; then
        start_this
    fi
}
